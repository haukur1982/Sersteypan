# Rebar Research & AI Drawing Analysis Plan — Extracted from Session 9e40d435

This document contains the comprehensive rebar/drawing research and implementation plan extracted from a Claude Code conversation transcript (51MB, 7439 messages). The session covered the design, implementation, and refinement of an AI-powered drawing analysis system for a precast concrete factory.

---

## Table of Contents

1. [Context & Problem Statement](#1-context--problem-statement)
2. [Comprehensive Implementation Plan](#2-comprehensive-implementation-plan)
3. [Approved Plan (Condensed)](#3-approved-plan-condensed)
4. [Gap Analysis: Real Drawings vs Code Assumptions](#4-gap-analysis-real-drawings-vs-code-assumptions)
5. [Drawing Type Analysis Results](#5-drawing-type-analysis-results)
6. [AI Model Comparison Research](#6-ai-model-comparison-research)
7. [System Assessment & Self-Critique](#7-system-assessment--self-critique)
8. [Post-Implementation Improvements](#8-post-implementation-improvements)
9. [Production Batch & Quality System Assessment](#9-production-batch--quality-system-assessment)
10. [Step-by-Step User Flow](#10-step-by-step-user-flow)
11. [Implementation Completion Summary](#11-implementation-completion-summary)
12. [Full Session Handoff Summary](#12-full-session-handoff-summary)

---

## 1. Context & Problem Statement

The factory owner (Jón Gunnar) described these pain points in his emails:

**From the emails (Icelandic with translations):**
- **Email 1**: "dæmi um filigran teikningar" — example filigran drawings, "Þetta er fyrsta hæð af 6" (this is first floor of 6)
- **Email 2**: "dæmi um svalir og svalagangar" — balcony and corridor examples
- **Email 3**: "stigar — allar þessar teikningar eru úr sömu bygginguni" — stairs, all drawings from the same building
- **Email 4** (the big one — Jón Gunnar's detailed feedback)

**Admin pain points:**
- "GG gaman er með 20 teikningar. lengi að henda inn einu og einu" — tedious to upload one by one
- "Stofna eina einingu í einu tekur mikinn tíma" — creating one element at a time takes too long
- "Skoða að hlaða inn upplýsingar í gegnum teikningu eða vera með multi insert" — look at loading info through drawing or have multi-insert

**Factory manager workflow described:**
- "Framleiðslustjóri þarf að staðfesta að hann hafi farið yfir þessa liði áður en steypan fer í móttið og það er tekið fram í batch skrránni" — Factory manager must confirm he's checked these items before concrete goes in the mold
- Each element gets a barcode when created
- FM checks off elements prepared for casting, takes photos of rebar and electrical components
- Production isn't always in order — they hop between floors to fill the casting board
- ~10 filigran + 2 balconies + 1 staircase per concrete truck
- FM checks elements, uploads photos, uploads concrete slip → creates Batch number
- If a defect is found in element F(A)1-1, you should be able to look up ALL elements from that Batch
- Full traceability: drawing → rebar photo → batch number → concrete slip → driver photos

---

## 2. Comprehensive Implementation Plan

*(27,207 characters — the full implementation plan generated by the exploration subagent)*

### Architecture Overview

The system has a multi-stage pipeline:

```
Upload PDFs  -->  Convert to images (server-side)  -->  Send to Claude Vision API  -->  
Structured JSON extraction  -->  Admin review/edit UI  -->  Bulk insert to database
```

The pipeline is deliberately split into discrete, auditable steps with human review as a hard gate before any data touches the database.

### Database Changes (Migration 027)

**New Table: `drawing_analyses`** — staging area between AI extraction and element creation:
- `id`, `project_id` (FK), `document_id` (FK to project_documents, nullable)
- `status`: pending → processing → completed → failed → reviewed → committed
- `extracted_elements` (JSONB array — the core AI output)
- `ai_summary`, `ai_model`, `ai_confidence_notes`
- `reviewed_by`, `reviewed_at`, `review_notes`
- `elements_created` (integer count)

**New column on `elements`**: `rebar_spec text` — rebar specifications from structural drawings.

### API Route: `/api/ai/analyze-drawing`

**PDF Handling**: Send PDF directly to Claude API as `document` content block (Anthropic SDK supports PDF natively). No image conversion needed.

### Claude Vision Prompt Strategy

**System prompt** (English for better technical accuracy):

```
You are a structural engineering drawing analyzer specializing in Icelandic precast concrete (steyptir forsteyptir) production.

CRITICAL RULES:
1. Only extract information that is CLEARLY visible in the drawing. Never guess.
2. Mark confidence level for each field (high/medium/low).
3. If a value is ambiguous, set it to null and add a note.
4. Dimensions are always in millimeters (mm).
5. Weights may be in tons (tonn) or kilograms (kg). Convert everything to kg.

ELEMENT NAMING CONVENTIONS (Icelandic structural engineering):
- F = Filigran (floor slabs). Pattern: F(X)-Y-Z where X=building, Y=floor, Z=element number
- SV = Svalir (balconies)
- SG = Svalagangar (balcony corridors)  
- V = Veggur (walls)
- S = Stigi (staircase)
- Su = Súla (column)
- B = Bita (beam)
- Þ = Þak (ceiling/roof)

DRAWING TYPES:
- BF-x: Búnaðarteikning Filigran (Filigran layout drawing)
- BS-x: Búnaðarteikning Svalir/Stigar (Balcony/Stair detail drawing)
- A.x.x: Arkitektateikning (Architectural drawing — less technical detail)

REBAR NOTATION:
- "K10 c/c 200" means K10 bars at 200mm center-to-center spacing
- Two directions typically specified (length and width)
- "Bogakambur" = shear comb
```

**Return schema**: JSON with `drawing_reference`, `drawing_type`, `building`, `floor`, `general_notes`, `elements[]` (each with name, type, dimensions, weight, quantity, rebar_spec, confidence levels), `warnings[]`, `page_description`.

### Weight Calculation Formulas

Concrete density ~2400 kg/m³ for standard reinforced concrete:
- **Filigran**: 60mm thick plates. Weight = L × W × 0.060 × 2400
- **Balconies**: Use actual weight from drawings (complex shapes)
- **Stairs**: Complex geometry; prefer AI-extracted weight or manual
- **Walls**: L × W × thickness × density

### New Pages & Components

1. `/admin/projects/[projectId]/analyze-drawings/page.tsx` — Upload + analysis list
2. `/admin/projects/[projectId]/analyze-drawings/[analysisId]/page.tsx` — Review + commit
3. Components: `DrawingUploadZone`, `AnalysisStatusCard`, `ElementReviewTable`, `ConfidenceBadge`, `WeightCalculator`, `AnalysisSummary`, `DrawingPreviewPanel`

### Server Actions

- `startDrawingAnalysis(projectId, documentIds[])` — triggers AI analysis
- `commitAnalysisElements(analysisId, selectedIndices[], buildingMappings)` — bulk-creates elements
- Auto-creates buildings detected by AI
- Expands quantities (e.g., SV-1 with 21 units across floors → 21 individual elements)

### Safety Guarantees

1. Human-in-the-loop: AI extraction is ALWAYS a proposal
2. Confidence scoring per field
3. Duplicate detection
4. Editable before commit
5. Audit trail preserved
6. Rate limiting (5 per 5 minutes)
7. Existing validation via `elementBatchCreateSchema`

---

## 3. Approved Plan (Condensed)

The approved plan mirrors the comprehensive plan above with these confirmed design decisions:

1. **Auto-create buildings**: AI detects building names from drawings and offers to create them during review
2. **Expand quantities per floor**: Balcony elements expanded into individual tracked elements
3. **Add 'svalagangur' element type**: New type distinct from svalir (balconies)

---

## 4. Gap Analysis: Real Drawings vs Code Assumptions

After studying every real drawing and every line of the extraction code:

### Drawing BF-1, BF-2, BF-3, BF-4 (Filigran/Floor Slabs)

Each element shown as rectangle with:
- **Name** in center (e.g., `F(A)-1-1`)
- **Rebar spec in ellipse** (e.g., `K10 c/c 200` in two directions)
- **Dimension lines** on edges
- **No weight shown** — filigran drawings don't list weight per element
- **No explicit quantity** — each element drawn individually
- Elements with "(2)" suffix = second variant: `F(A)-1-3(2)`, `F(B)-1-2+(2)`
- General notes: "Filegranplötur eru 6cm þykkar með 140mm háum skerkónúm c/c 600"

**Key gaps identified:**
- Dimensions are positional, not L×W×H per element
- Thickness in general notes (60mm), not per-element
- No weight listed — must calculate
- "(2)" variants are separate elements, not duplicates

### Drawing BS_01 (Balconies - Svalir)

- Two types: SV-1 and SV-2
- Floor breakdown: "4H: 3.stk / 3H: 6.stk / 2H: 6.stk / 1H: 6.stk"
- Weight explicitly stated: "Þyngd c.a. 4.1 tonn" (SV-1), "Þyngd c.a. 3.8 tonn" (SV-2)
- Rebar: "K10 c/c 200", "K10 c/c 250", "U-lektor K10 c/c 200"
- Concrete spec: "ALLAR SVALAPLÖTUR SKULU STEYPTAR MED C30/37 STENSTEYPU"

### Drawing BS_02 / Svalagangar 54 (Corridor Balconies)

- 20 corridor elements: SG-1 through SG-20
- Individual weights: ~2.6 to ~3.3 tonn
- Some with variable length: "L = 500 + Mátbr + 500" (field measurement)
- Rebar: "K10 c/c 200", "K18 c/c 200", "2 K12 / blokúþolm"

### Drawing A.1.9 (Architectural)

- Elevation drawing — NOT structural. No elements to extract.
- System must handle gracefully and return empty.

### Drawing BS-2 (Stairs)

- Three types: Stigategundar A, B, C
- "9 þrepa / Uppíð 161mm / Framrás 270mm / Innbreidd 30mm / Stigabreidd 1180mm"
- Rebar: "Laðkor K8 c/c 100", "K10 c/c 150", "K10 c/c 200"
- No weight — needs estimation (complex geometry)

---

## 5. Drawing Type Analysis Results

After studying real drawings, 4 distinct types identified:

| Drawing | Type | Elements | Key Pattern |
|---------|------|----------|-------------|
| BF-1 to BF-4 | Filigran (floor slabs) | 41, 8, 24, 29 elements | Each slab drawn individually, qty=1, rebar in ellipses, thickness in general notes (60mm) |
| BS_01 | Balconies (svalir) | 2 types (SV-1, SV-2) | Weight in tons, floor breakdown (4H: 3.stk...), concrete class C30/37 |
| BS_02 / Svalagangar 54 | Corridors (svalagangar) | 20 elements (SG-1 to SG-20) | Individual weights, some with variable length ("Mátbr"), rebar details per element |
| BS-2 | Stairs (stigar) | 3 types (A, B, C) | Step counts, rise/tread specs, no weight given, complex geometry |
| A.1.9 | Architectural elevation | 0 (no elements) | Facade view — not a production drawing |

**Changes made based on analysis:**
1. Rewrote AI system prompt from scratch — 5x longer, with dedicated sections per drawing type
2. Architectural drawing handling (return empty)
3. Filigran-specific guidance (rectangles, thickness from general notes, rebar from ellipses)
4. Balcony weight conversion ("Þyngd c.a. 4.1 tonn" = 4100 kg)
5. Variable dimensions for SG elements with "Mátbr"
6. Stair handling (step details to production_notes, weight=null)
7. Updated element type mapping
8. Confidence level: **80-85%** after rewrite

---

## 6. AI Model Comparison Research

### Claude Opus 4.6 vs Gemini 3 Deep Think (February 2026)

| | **Claude Opus 4.6** (in use) | **Gemini 3 Deep Think** |
|---|---|---|
| **Status** | GA, full API access | Early access only — invite-based |
| **Pricing** | $5 / $25 per 1M tokens | Gemini 3 Pro: $2 / $12. Deep Think: not public |
| **Context** | 1M tokens (beta) | 1M tokens |
| **Vision/PDF** | Native PDF | Native PDF with media_resolution control |
| **Structured JSON** | Yes | Yes + combinable with built-in tools |
| **Reasoning** | Standard | Extended thinking — 84.6% on ARC-AGI-2 |
| **MMMU (visual)** | ~75% | Higher (Gemini 2.5 was 81.7%) |

**Assessment**: Gemini 3 Deep Think would likely be better for reading engineering drawings (extended reasoning + higher visual benchmarks), but it's early access only. The prompt works with any model — the model is swappable. **Recommendation**: test with Claude Opus 4.6 first, add Gemini support later.

---

## 7. System Assessment & Self-Critique

### What's Really Good

- The 230-line system prompt handles nuances of Icelandic structural drawings
- Two-step review flow (AI extracts, human approves) is the right design
- Quantity expansion logic parsing "4H: 3stk, 3H: 6stk" saves enormous manual work
- E2E test: 8 real drawings → 129 AI-extracted elements → 160 committed elements → 13 batches → all completed in 23 seconds

### What Needed Improvement (later addressed)

1. No inline editing during review
2. No side-by-side PDF view
3. Polling was basic (3s intervals with page reload)
4. No batch analysis view
5. 108 low-confidence weight warnings were noisy (filigran weights are calculable)

---

## 8. Post-Implementation Improvements

### 5 Improvements Implemented

1. **Smarter Weight Confidence** — `getWeightConfidenceOverride()` upgrades confidence for calculable slab types. Blue "Reiknað" badge.
2. **Inline Editing** — `EditableCell.tsx` click-to-edit component for all fields during review.
3. **Realtime Subscriptions** — Replaced polling with Supabase Realtime on `drawing_analyses` table.
4. **Side-by-Side PDF View** — `react-resizable-panels` for split-screen review.
5. **Combined Analysis View** — `/combined` page showing all elements across all drawings with filtering.

---

## 9. Production Batch & Quality System Assessment

### What's Good (High Confidence)
- Database schema is correct (production_batches with JSONB checklist, batch_id FK on elements)
- Traceability chain is complete (Drawing → Rebar → Batch → Checklist → Cast → Curing → Ready → Loaded → Delivered)
- Defect tracking has root_cause, corrective_action, lessons_learned
- Atomic batch completion RPC prevents partial states

### Gaps Found (vs Owner's Mockups)
1. No element-type grouping in batch creation (flat list vs tabs)
2. No unified "Manage Production" page (split across 3 pages)
3. Air temperature field missing (important for concrete curing)
4. Production list doesn't show batch info
5. Defect photos UI not built
6. Checklist enforcement warning not prominent enough
7. Batch number generation has race condition

### Improvements Implemented
1. Air temperature on batches (migration 035)
2. Batch info in production queue
3. Element-type grouped batch creation (Filigran | Balcony | Stairs | Columns tabs)
4. Checklist enforcement warning (red banner + confirmation dialog)
5. Defect photo upload component
6. Traceability timeline showing full lifecycle (9 steps)
7. Unified "Manage Production" page (`/factory/manage`)

---

## 10. Step-by-Step User Flow

### Step 1: Navigate to Analysis Page
`/admin/projects/[projectId]/analyze-drawings` — upload zone + existing analyses list

### Step 2: Upload Drawings
Drag-and-drop PDFs → uploaded to Supabase Storage → AI analysis triggered automatically

### Step 3: Watch AI Work
Status cards poll/realtime: Pending → Processing → Completed/Failed. Each analysis 10-100 seconds.

### Step 4: Review Results
Side-by-side: PDF preview (left) | editable element table (right). Confidence badges, duplicate warnings, quantity expansion preview. Table columns:

| ☐ | Nafn | Tegund | Bygging | Hæð | L × B × H (mm) | Þyngd (kg) | Magn | Járn | Öryggi |
|---|------|--------|---------|-----|-----------------|-------------|------|------|--------|

### Step 5: Select and Commit
Confirmation dialog shows: elements selected → elements after expansion → new buildings to create. System creates buildings, expands quantities, inserts elements as 'planned'.

### Step 6: After Commit
Analysis marked as "Staðfest" (Committed). Elements enter production pipeline at `planned` status.

---

## 11. Implementation Completion Summary

### Files Created (12 new)
| File | Purpose |
|------|---------|
| `supabase/migrations/027_drawing_analysis.sql` | New table + rebar_spec column + svalagangur type |
| `src/lib/schemas/drawing-analysis.ts` | Zod schemas for AI extraction validation |
| `src/lib/drawing-analysis/weight.ts` | Concrete weight calculator |
| `src/lib/drawing-analysis/actions.ts` | Server actions (start, review, commit, delete) |
| `src/lib/drawing-analysis/queries.ts` | Data fetching queries |
| `src/app/api/ai/analyze-drawing/route.ts` | AI analysis API (Claude + PDF) |
| `src/app/api/ai/analyze-drawing/status/route.ts` | Status polling endpoint |
| `src/components/drawing-analysis/ConfidenceBadge.tsx` | Confidence level badges |
| `src/components/drawing-analysis/AnalysisStatusCard.tsx` | Analysis progress card |
| `src/components/drawing-analysis/DrawingUploadZone.tsx` | Multi-PDF drag-and-drop upload |
| `src/components/drawing-analysis/ElementReviewTable.tsx` | Core review table |
| Both `analyze-drawings/` pages | Upload list + Review/commit pages |

### Files Modified (6 existing)
- `src/types/database.ts` — Added drawing_analyses types + rebar_spec
- `src/lib/schemas/elements.ts` — Added rebar_spec to element schemas
- `src/lib/elements/actions.ts` — Added rebar_spec to create/update/parse
- `src/lib/documents/actions.ts` — Returns documentId from upload
- `src/components/elements/ElementForm.tsx` — Added rebar spec input
- `src/app/(portals)/admin/projects/[projectId]/page.tsx` — Added "Greina teikningar" button

---

## 12. Full Session Handoff Summary

The session also implemented **7 factory production improvements** (separate from the drawing analysis system):

1. **Air Temperature on Batches** — `air_temperature_c` column, RPC update, UI input
2. **Batch Info in Production Queue** — "Lota" column with clickable batch links
3. **Element-Type Grouped Batch Creation** — Tabs (Filigran/Svalir/Svalagangur/Stigi/Veggur/Annað) with floor sub-groups
4. **Checklist Enforcement Warning** — Red banner + confirmation dialog before batch completion
5. **Defect Photo Upload** — `DefectPhotoUpload.tsx` component, max 5 photos, stored in element-photos bucket
6. **Traceability Timeline Full Lifecycle** — All 9 steps always visible (completed/current/future)
7. **Unified Manage Production Page** — `/factory/manage` with project selector, stats, inline checklist toggle, elements grouped by type+floor

All changes verified: `tsc --noEmit` (0 errors), `lint` (0 errors), `build` (all routes compiled).
